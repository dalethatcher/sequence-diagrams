<!DOCTYPE html>
<html>
<head>
    <title>Bootstrap 101 Template</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
</head>
<body>
<div class="container-fluid">
    <div class="row-fluid">
        <div class="span4">
            <textarea></textarea>
        </div>
        <div class="span8" id="drawing">
        </div>
    </div>
</div>
<script src="http://code.jquery.com/jquery.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script src="raphael/js/raphael-min.js"></script>
<script lang="text/javascript">
    var paper = new Raphael(document.getElementById('drawing'), 1000, 1000);

    function drawActor(name, x) {
        var textElement = paper.text(x + 5, 0, name);
        textElement.attr({
            "font-size": 36,
            'text-anchor': 'start'
        });
        var rect = textElement.getBBox();
        textElement.attr({ y: rect.height/2 + 15 });
        rect = textElement.getBBox();

        paper.rect(rect.x - 5, rect.y - 5, rect.width + 10, rect.height + 10).attr({
            fill: "white",
            stroke: "black",
            r: 5
        });
        textElement.toFront();

        var lifelinePath = "M" + (rect.x + rect.width/2) + "," + (rect.y + rect.height + 5) + "V1000";
        var lifeLine = paper.path(lifelinePath);
        lifeLine.attr({ "stroke-dasharray": "--" });
        lifeLine.toBack();

        return rect.x + rect.width + 5;
    }

    function uniqueActorSet(diagram) {
        var result = [];
        var found = {};
        var i;

        function addIfNew(actor) {
            if (!found[actor]) {
                result[result.length] = actor;
                found[actor] = 1;
            }
        }

        for (i = 0; i < diagram.length; i++) {
            addIfNew(diagram[i][0]);
            addIfNew(diagram[i][1]);
        }

        return result;
    }

    function drawActors(diagram) {
        var i;
        var lastX = 10;
        var uniqueActors = uniqueActorSet(diagram);
        var actorPositions = {};

        for (i = 0; i < uniqueActors.length; i++) {
            var newX = drawActor(uniqueActors[i], lastX);
            var midX = (newX + lastX) / 2;
            lastX = newX + 10;

            actorPositions[uniqueActors[i]] = midX;
        }

        return actorPositions;
    }

    function drawArrow(x, y, pointRight) {
        var ARROW_WIDTH = 10;
        var ARROW_HEIGHT = 10;
        var HALF_ARROW_HEIGHT = ARROW_HEIGHT/2;
        var xDelta = pointRight ? -ARROW_WIDTH : ARROW_WIDTH;
        var path = paper.path(
                "M" + x + "," + y +
                "l" + xDelta + "," + -HALF_ARROW_HEIGHT +
                "l0," + ARROW_HEIGHT +
                "Z");
        path.attr({
            fill: 'black'
        });
    }

    function drawCalls(diagram, actorPositions) {
        var SPAN = 40;
        var lastY = 90;
        var i;

        for (i = 0; i < diagram.length; i++) {
            var fromActor = diagram[i][0];
            var toActor = diagram[i][1];
            var from = actorPositions[fromActor] + "," + lastY;

            if (fromActor == toActor) {
                paper.path("M" + from + "l35,0l0," + SPAN + "l-35,0");
                lastY += SPAN;
                drawArrow(actorPositions[toActor], lastY, false);
            }
            else {
                var to = actorPositions[toActor] + "," + lastY;
                var pointRight = actorPositions[toActor] > actorPositions[fromActor];

                paper.path("M" + from + "L" + to);
                drawArrow(actorPositions[toActor], lastY, pointRight);
            }


            lastY += SPAN;
        }
    }

    function drawDiagram(diagram) {
        var actorPositions = drawActors(diagram);

        drawCalls(diagram, actorPositions);
    }

    drawDiagram([
            ["Alice", "Bob", "calls"],
            ["Bob", "Charlie", "passes"],
            ["Charlie", "Charlie", "invokes"],
            ["Charlie", "Alice", "returns"]
    ]);

</script>
</body>
</html>
